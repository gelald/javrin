import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as n,o as t}from"./app-BH1OTr4j.js";const e={};function h(l,s){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="metrics-nan-é—®é¢˜è¿½è¸ª" tabindex="-1"><a class="header-anchor" href="#metrics-nan-é—®é¢˜è¿½è¸ª"><span>Metrics NaN é—®é¢˜è¿½è¸ª</span></a></h1><blockquote><p>ä»¥ä¸‹ä½¿ç”¨çš„ä»£ç éƒ½æ˜¯ç»è¿‡è„±æ•çš„ç¤ºä¾‹ä»£ç </p></blockquote><h2 id="é—®é¢˜å¼•å…¥" tabindex="-1"><a class="header-anchor" href="#é—®é¢˜å¼•å…¥"><span>é—®é¢˜å¼•å…¥</span></a></h2><p>æˆ‘åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­è´Ÿè´£äº†ä¸€ä¸ª metrics çš„æ”¶é›†ä¸å±•ç¤ºï¼Œæœ¬æ¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæ¯ 30 ç§’å®šæ—¶æ›´æ–°åˆ° metrics ä¸­ï¼Œå¾ˆå¿«å°±å†™å®Œã€æµ‹è¯•é€šè¿‡å¹¶ä¸Šçº¿äº†ã€‚</p><p>metrics æ•°æ®å¤§æ¦‚æ˜¯è¿™æ ·ï¼š</p><p><code>app_version_metrics {Code=â€0â€, Version=â€1.0.1â€,} 55</code></p><p><code>app_version_metrics {Code=â€0â€, Version=â€1.0.2â€,} 20</code></p><p>Grafana æ ¹æ®è¿™ä¸ªæ•°æ®çš„æ ¼å¼å±•ç¤ºåœ¨ dashboard ä¸Šã€‚ç›´åˆ°åé¢æœ‰ä¸€å¤©è¿™ä¸ªåº”ç”¨å‘ç”Ÿäº† OOMï¼Œåœ¨æ’æŸ¥çš„åŒæ—¶ï¼Œå‘ç°è¿™ä¸ª metrics æœ‰æ—¶å€™ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š</p><p><code>app_version_metrics {Code=â€0â€, Version=â€1.0.1â€,} NaN</code></p><p>count å±…ç„¶æ˜¾ç¤ºçš„æ˜¯ â€œNaNâ€ (Not a number) è€Œä¸æ˜¯ä¸€ä¸ªæ­£å¸¸çš„æ•°å­—</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> putMetrics</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">MetricsVersionDTO</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> metricsVersionDTOList) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MetricsVersionDTO</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> metricsVersionDTO </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> metricsVersionDTOList) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> version </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> metricsVersionDTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">version</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> metricsVersionDTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;[refreshVersionForMetrics] version: {}, count: {}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, version, count);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        meterRegistry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gauge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;app_version_metrics&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Tags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">of</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Code&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Version&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, version), count);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ—¶çœ‹åˆ°æ—¥å¿—ä¸­æ¯æ¬¡éƒ½èƒ½æ­£å¸¸æ˜¾ç¤ºï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>[refreshVersionForMetrics] version: 1.0.1, count: 55</span></span>
<span class="line"><span>[refreshVersionForMetrics] version: 1.0.2, count: 20</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹æ—¥å¿—å‘ç°è¿™ä¸ª count æ¯æ¬¡éƒ½èƒ½è®¾ç½®åˆ°ä¸€ä¸ªæ­£å¸¸çš„æ•°å€¼ï¼Œå®åœ¨ç™¾æ€ä¸å¾—å…¶è§£ã€‚</p><h2 id="è¿½è¸ªé—®é¢˜" tabindex="-1"><a class="header-anchor" href="#è¿½è¸ªé—®é¢˜"><span>è¿½è¸ªé—®é¢˜</span></a></h2><p>ç”±äºè¿™ä¸ªåº”ç”¨ä¸æ˜¯ä¸€ä¸ªæ ¸å¿ƒåº”ç”¨ï¼Œåæ•°æ®æ”¶é›†å±•ç¤ºçš„åº”ç”¨ï¼Œæ‰€ä»¥ OOM é—®é¢˜æ²¡æœ‰å¾ˆé‡è§†ï¼Œå…ˆå¤šåˆ†é…äº† 100 M å†…å­˜å°±æ²¡æœ‰ç»§ç»­çœ‹äº†ã€‚</p><p>åç»­ç›¯ç€çœ‹äº†è®¸ä¹…ï¼Œæ²¡æœ‰å‡ºç° NaN é—®é¢˜äº†ã€‚</p><p>ç›´åˆ°ä¸€æ˜ŸæœŸåï¼ŒOOM é—®é¢˜å†åº¦å‡ºç°ï¼Œå¹¶ä¸” NaN çš„é—®é¢˜åŒæ­¥å‡ºç°ã€‚OOM çš„é—®é¢˜å…¶ä»–åŒäº‹åœ¨æ ¹æ®ï¼Œä½†æ˜¯ NaN çš„é—®é¢˜è®©æˆ‘ä¸ç”±æƒ³åˆ°ä¸ OOM æœ‰å…³è”ã€‚</p><p>è¿™ä¸ª count å¤§æ¦‚ç‡æ˜¯è¢« GC äº†æ‰ä¼šå˜æˆ NaN çš„ï¼Œå¦åˆ™ä»–åº”è¯¥æ˜¯ä¸€ä¸ªå¸¸é©»å†…å­˜çš„å¯¹è±¡ã€‚</p><p>å›çœ‹ä¸€å¼€å§‹çš„ä»£ç ï¼Œèƒ½çœ‹åˆ°è¿™ä¸ª count çš„æ¥æºæ˜¯å±€éƒ¨å˜é‡ï¼šmetricsVersionDTO</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">meterRegistry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gauge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;app_version_metrics&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Tags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">of</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Code&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Version&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, version), count);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ’æŸ¥åˆ°è¿™é‡Œæœ‰äº†å¤§æ¦‚çš„æƒ³æ³•ï¼Œåº”è¯¥æ˜¯å†…å­˜ä¸è¶³è¢« GC äº†ï¼Œäºæ˜¯åœ¨ç½‘ä¸Šå†æœé›†äº†ä¸€äº›èµ„æ–™ã€‚</p><h3 id="âš ï¸-ä¸»è¦åŸå› åˆ†æ" tabindex="-1"><a class="header-anchor" href="#âš ï¸-ä¸»è¦åŸå› åˆ†æ"><span>âš ï¸ ä¸»è¦åŸå› åˆ†æ</span></a></h3><p>metrics ä¸­ <code>count</code>å€¼åœ¨ Prometheus ä¸­å¶å°”æ˜¾ç¤ºä¸º <code>NaN</code>ï¼Œé€šå¸¸ä¸ Micrometer ä¸­ Gauge çš„å·¥ä½œæœºåˆ¶æœ‰å…³ã€‚<strong>Gauge éœ€è¦å¯¹ä¸€ä¸ªæŒç»­å­˜åœ¨çš„çŠ¶æ€å¯¹è±¡ä¿æŒå¼ºå¼•ç”¨</strong>ï¼Œå¦åˆ™å½“è¯¥å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰åï¼ŒGauge å°±æ— æ³•è·å–å…¶å€¼ï¼Œä»è€Œè¿”å› <code>NaN</code>ã€‚</p><p>æ ¸å¿ƒåŸå› åœ¨äºä»£ç ä¸­çš„ <code>count</code>æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼ˆ<code>Long</code>ç±»å‹ï¼‰ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚<code>meterRegistry.gauge</code>æ–¹æ³•æ³¨å†Œçš„ Gauge é»˜è®¤<strong>ä¸æŒæœ‰</strong>æä¾›çš„è¿™ä¸ª <code>count</code>å¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚å½“åƒåœ¾å›æ”¶å™¨å›æ”¶æ‰è¿™ä¸ª <code>count</code>å¯¹è±¡åï¼Œä¸‹æ¬¡ Prometheus æŠ“å–æ—¶ï¼ŒGauge å°è¯•è·å–å€¼å°±ä¼šå¤±è´¥ï¼Œä»è€Œè¿”å› <code>NaN</code>ã€‚</p><h3 id="ğŸ› ï¸-æ¨èçš„è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ› ï¸-æ¨èçš„è§£å†³æ–¹æ¡ˆ"><span>ğŸ› ï¸ æ¨èçš„è§£å†³æ–¹æ¡ˆ</span></a></h3><p>ä¿®æ”¹ä»£ç ï¼Œç¡®ä¿ä¸ºæ¯ä¸ªå”¯ä¸€çš„æ ‡ç­¾ç»„åˆï¼ˆå³æ¯ä¸ªä¸åŒçš„ <code>version</code>ï¼‰éƒ½å¯¹åº”ä¸€ä¸ªè¢«<strong>å¼ºå¼•ç”¨</strong>çš„çŠ¶æ€å¯¹è±¡ï¼ˆä¾‹å¦‚ <code>AtomicLong</code>ï¼‰ã€‚å¹¶ä¸”é€šå¸¸çš„åšæ³•ä¼šä½¿ç”¨ä¸€ä¸ª <code>Map</code>æ¥ç®¡ç†è¿™äº›å¯¹è±¡ã€‚</p><h3 id="ğŸ’¡-å…¶ä»–æ³¨æ„äº‹é¡¹" tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-å…¶ä»–æ³¨æ„äº‹é¡¹"><span>ğŸ’¡ å…¶ä»–æ³¨æ„äº‹é¡¹</span></a></h3><p><strong>åˆå§‹å€¼</strong>ï¼šå¯ä»¥åœ¨åˆ›å»º <code>AtomicLong</code>æ—¶èµ‹äºˆåˆå§‹å€¼ <code>0</code>ï¼Œè¿™å¯ä»¥é¿å…åœ¨ç¬¬ä¸€æ¬¡è®¾ç½®å…·ä½“æ•°å€¼ä¹‹å‰ Prometheus æŠ“å–åˆ° <code>NaN</code>ã€‚</p><p>ä¿®æ”¹åä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MetricsComponent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MeterRegistry</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> meterRegistry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ä½¿ç”¨ConcurrentHashMapæ¥ç»´æŠ¤å¯¹AtomicLongçš„å¼ºå¼•ç”¨ï¼ŒKeyä¸ºæ ‡ç­¾ç»„åˆçš„å­—ç¬¦ä¸²å½¢å¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ConcurrentHashMap</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AtomicLong</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gaugeMap </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ConcurrentHashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> MetricsComponent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MeterRegistry</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> meterRegistry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">meterRegistry</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> meterRegistry;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> putMetrics</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MetricsVersionDTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">metricsVersionDTOList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MetricsVersionDTO</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> metricsVersionDTO</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> metricsVersionDTOList) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> version</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> metricsVersionDTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">version</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> metricsVersionDTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">		        log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;[refreshVersionForMetrics] version: {}, count: {}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, version, count);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // æ ¹æ®æ ‡ç­¾ç»„åˆç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„Key</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gaugeKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">format</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;%s-%s&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, version);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // è·å–æˆ–åˆ›å»ºå¯¹åº”çš„AtomicLong</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            AtomicLong</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gaugeCount</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> gaugeMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">computeIfAbsent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(gaugeKey, k </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                AtomicLong</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> newLong</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> AtomicLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // æ³¨å†ŒGaugeï¼Œå¹¶å§‹ç»ˆå¼•ç”¨è¿™ä¸ªnewLong</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                Gauge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">builder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;app_version_metrics&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, newLong, AtomicLong</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">::</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">get)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Tags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">of</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Code&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Version&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, version))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">register</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(meterRegistry);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newLong;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // æ›´æ–°AtomicLongçš„å€¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            gaugeCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(count);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Updated app_version_metrics: {}, value: {}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, gaugeKey, count);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h1><p>çœ‹ä¼¼ç®€å•çš„â€œç»Ÿè®¡ä¸ŠæŠ¥â€é€»è¾‘ï¼Œå®åˆ™éšå«å¯¹<strong>å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</strong>çš„å¼ºä¾èµ–ã€‚å¦‚æœå¯¹ Micrometer çš„å·¥ä½œæœºåˆ¶ç†è§£ä¸æ·±ï¼Œææ˜“å› â€œå±€éƒ¨å˜é‡é»˜è®¤é‡Šæ”¾â€çš„æƒ¯æ€§æ€ç»´ï¼Œè§¦å‘ GC å¯¼è‡´çš„æŒ‡æ ‡å¤±æ•ˆ</p><p>å†…å­˜ç®¡ç†çš„è´è¶æ•ˆåº”ï¼ŒOOM ä¸ metrics å¼‚å¸¸ç»éå­¤ç«‹äº‹ä»¶ã€‚å†…å­˜å‹åŠ›ä¸‹ GC çš„â€œä¸å¯æ§å›æ”¶â€ï¼Œä¼šé€šè¿‡â€œå¯¹è±¡é”€æ¯â†’çŠ¶æ€ä¸¢å¤±â†’æŒ‡æ ‡å¼‚å¸¸â€çš„é“¾æ¡ï¼Œå°†èµ„æºé—®é¢˜ä¼ å¯¼è‡³ç›‘æ§ä½“ç³»ã€‚è¿™å°è¯äº†ä¸€ä¸ªå…³é”®è®¤çŸ¥ï¼š<strong>ä»»ä½•é•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼Œâ€œå†…å­˜ä¸èµ„æºç®¡ç†â€éƒ½éœ€å‰ç½®è€ƒé‡</strong>ï¼Œä¸èƒ½å› åŠŸèƒ½â€œéæ ¸å¿ƒâ€è€Œæ”¾æ¾ç¨³å®šæ€§è¦æ±‚ã€‚</p>`,35)])])}const r=i(e,[["render",h]]),d=JSON.parse('{"path":"/writings/JVM/metrics-gc-issue.html","title":"Metrics NaN é—®é¢˜è¿½è¸ª","lang":"zh-CN","frontmatter":{"title":"Metrics NaN é—®é¢˜è¿½è¸ª","icon":"note-sticky","category":["JVM"],"tag":["ç›‘æ§","è°ƒä¼˜"],"description":"Metrics NaN é—®é¢˜è¿½è¸ª ä»¥ä¸‹ä½¿ç”¨çš„ä»£ç éƒ½æ˜¯ç»è¿‡è„±æ•çš„ç¤ºä¾‹ä»£ç  é—®é¢˜å¼•å…¥ æˆ‘åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­è´Ÿè´£äº†ä¸€ä¸ª metrics çš„æ”¶é›†ä¸å±•ç¤ºï¼Œæœ¬æ¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæ¯ 30 ç§’å®šæ—¶æ›´æ–°åˆ° metrics ä¸­ï¼Œå¾ˆå¿«å°±å†™å®Œã€æµ‹è¯•é€šè¿‡å¹¶ä¸Šçº¿äº†ã€‚ metrics æ•°æ®å¤§æ¦‚æ˜¯è¿™æ ·ï¼š app_version_metrics {Code=â€0â€, Version...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Metrics NaN é—®é¢˜è¿½è¸ª\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-09-07T08:39:58.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"gelald\\",\\"url\\":\\"https://github.com/gelald\\"}]}"],["meta",{"property":"og:url","content":"https://gelald.github.io/javrin/javrin/writings/JVM/metrics-gc-issue.html"}],["meta",{"property":"og:site_name","content":"Javrin"}],["meta",{"property":"og:title","content":"Metrics NaN é—®é¢˜è¿½è¸ª"}],["meta",{"property":"og:description","content":"Metrics NaN é—®é¢˜è¿½è¸ª ä»¥ä¸‹ä½¿ç”¨çš„ä»£ç éƒ½æ˜¯ç»è¿‡è„±æ•çš„ç¤ºä¾‹ä»£ç  é—®é¢˜å¼•å…¥ æˆ‘åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­è´Ÿè´£äº†ä¸€ä¸ª metrics çš„æ”¶é›†ä¸å±•ç¤ºï¼Œæœ¬æ¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæ¯ 30 ç§’å®šæ—¶æ›´æ–°åˆ° metrics ä¸­ï¼Œå¾ˆå¿«å°±å†™å®Œã€æµ‹è¯•é€šè¿‡å¹¶ä¸Šçº¿äº†ã€‚ metrics æ•°æ®å¤§æ¦‚æ˜¯è¿™æ ·ï¼š app_version_metrics {Code=â€0â€, Version..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-07T08:39:58.000Z"}],["meta",{"property":"article:tag","content":"è°ƒä¼˜"}],["meta",{"property":"article:tag","content":"ç›‘æ§"}],["meta",{"property":"article:modified_time","content":"2025-09-07T08:39:58.000Z"}]]},"git":{"createdTime":1757233553000,"updatedTime":1757234398000,"contributors":[{"name":"gelald","username":"gelald","email":"37375083+gelald@users.noreply.github.com","commits":3,"url":"https://github.com/gelald"}]},"readingTime":{"minutes":3.76,"words":1128},"filePathRelative":"writings/JVM/metrics-gc-issue.md","autoDesc":true}');export{r as comp,d as data};
