import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o as c,c as o,a as n,b as a,d as t,e as i}from"./app-85442c0b.js";const l={},u=i(`<h1 id="mysql-批量插入数据" tabindex="-1"><a class="header-anchor" href="#mysql-批量插入数据" aria-hidden="true">#</a> MySQL 批量插入数据</h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>我们在操作大量数据写入数据库的时候，因为写入数据库涉及到磁盘 IO ，所以最合适的方案就是批量插入，具体反映到程序上面是如何批量插入呢？有哪些方案呢？我们带着这些问题一起向下看</p><h2 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h2><h3 id="数据库版本" tabindex="-1"><a class="header-anchor" href="#数据库版本" aria-hidden="true">#</a> 数据库版本</h3><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>mysql&gt; select version();
+-----------+
| version() |
+-----------+
| 8.0.29    |
+-----------+
1 row in set (0.00 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据库表结构" tabindex="-1"><a class="header-anchor" href="#数据库表结构" aria-hidden="true">#</a> 数据库表结构</h3><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>CREATE TABLE \`batch_maintain\` (
  \`maintain_id\` int(11) NOT NULL AUTO_INCREMENT,
  \`maintain_num\` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;保养工单编号&#39;,
  \`maintain_name\` varchar(1024) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;保养计划&#39;,
  \`equipment_num\` bigint(20) NOT NULL COMMENT &#39;设备编号&#39;,
  \`maintain_type\` int(11) NOT NULL COMMENT &#39;养护类型&#39;,
  \`functionary\` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT &#39;责任人&#39;,
  \`maintain_duration\` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT &#39;保养周期&#39;,
  \`start_time\` datetime DEFAULT NULL COMMENT &#39;开始时间&#39;,
  \`end_time\` datetime DEFAULT NULL COMMENT &#39;结束时间&#39;,
  \`maintain_status\` tinyint(4) NOT NULL COMMENT &#39;保养状态&#39;,
  PRIMARY KEY (\`maintain_id\`)
) ENGINE=InnoDB AUTO_INCREMENT=900001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT=&#39;保养工单&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="程序依赖" tabindex="-1"><a class="header-anchor" href="#程序依赖" aria-hidden="true">#</a> 程序依赖</h3><table><thead><tr><th>依赖</th><th>版本</th></tr></thead><tbody><tr><td>spring-boot-starter-web</td><td>2.6.1</td></tr><tr><td>mybatis-plus-boot-starter</td><td>3.5.2</td></tr><tr><td>HikariCP</td><td>4.0.3</td></tr><tr><td>mysql-connector-java</td><td>8.0.27</td></tr></tbody></table><h2 id="代码实现" tabindex="-1"><a class="header-anchor" href="#代码实现" aria-hidden="true">#</a> 代码实现</h2><p>MySQL插入数据主要是在获取连接、关闭连接、释放资源和提交事务等方面较耗能，如果使用 for 循环进行单条插入时，每次都在获取连接、释放连接和资源关闭等操作上花费时间，如果数据量大的情况下极其消耗资源，会导致操作时间过长，实际上这些资源都是可以复用起来，所以大批量数据插入时尽量使用批处理（批量插入），批处理对资源利用率更高，效率也就比单条插入更高。开启批处理需要在 JDBC 连接上配置批处理属性 <code>rewriteBatchedStatements=true</code> ，数据库驱动才会帮我们批量执行 SQL 语句。</p><p>虽然确定了使用批处理插入的方式，但还可以从这 3 个维度考虑这个问题</p><ul><li>JDBC 原生 / 框架封装的方法</li><li>直接提交 / 事务提交</li></ul><h3 id="事务与批量处理的区别" tabindex="-1"><a class="header-anchor" href="#事务与批量处理的区别" aria-hidden="true">#</a> 事务与批量处理的区别</h3><ul><li>事务是指一个包含多个步骤的操作，这些操作要么全部成功，要么全部失败；事务原理是把 SQL 语句存储在数据库服务器，没有提交事务的数据存放在数据库的临时表空间，<strong>消耗的是数据库服务器的内存空间</strong>，在最后提交事务的时候把临时表空间的数据提交到数据库服务端执行。</li><li>批处理是指把多个 SQL 语句缓存起来，最终一次性提交给数据库；把 SQL 语句缓存在 JDBC 客户端，<strong>会消耗客户端的内存</strong>，在最后提交时把客户端缓存的 SQL 语句提交到数据库服务端执行。</li></ul><h3 id="前置准备" tabindex="-1"><a class="header-anchor" href="#前置准备" aria-hidden="true">#</a> 前置准备</h3><p>由于会使用到原生的 JDBC，需要自行获取连接、创建语句集，因此我封装了一个 HikariCP 的工具类。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HikariCPUtils</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HikariDataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token comment">/*
     * 初始化数据源
     */</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 读取配置文件</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">HikariCPUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;hikaricp.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            properties<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 按照Hikaricp的配置加载Hikaricp配置类</span>
            <span class="token class-name">HikariConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HikariConfig</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据配置生成连接池</span>
            dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 通过数据源获取连接
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 关闭连接
     *
     * <span class="token keyword">@param</span> <span class="token parameter">connection</span> 数据库连接
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 关闭语句集和连接
     * 由于用了连接池，这里的关闭连接其实不是销毁，而是交还给连接池
     *
     * <span class="token keyword">@param</span> <span class="token parameter">statement</span>  语句集
     * <span class="token keyword">@param</span> <span class="token parameter">connection</span> 数据库连接
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                statement<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 关闭结果集、语句集和连接
     *
     * <span class="token keyword">@param</span> <span class="token parameter">resultSet</span>  结果集
     * <span class="token keyword">@param</span> <span class="token parameter">statement</span>  语句集
     * <span class="token keyword">@param</span> <span class="token parameter">connection</span> 数据库连接
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet<span class="token punctuation">,</span> <span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultSet <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                resultSet<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HikariCP 独立的配置文件 <code>hikaricp.properties</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 连接池名</span>
<span class="token key attr-name">poolName</span><span class="token punctuation">=</span><span class="token value attr-value">JDBC-DataSource</span>
<span class="token comment"># 数据库驱动|不填写HikariCp会自动识别</span>
<span class="token key attr-name">driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># 访问数据库连接</span>
<span class="token key attr-name">jdbcUrl</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/test?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=GMT%2B8&amp;useServerPrepStmts=true&amp;rewriteBatchedStatements=true</span>
<span class="token comment"># 数据库用户名</span>
<span class="token key attr-name">username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token comment"># 数据库密码</span>
<span class="token key attr-name">password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token comment"># 最大连接数</span>
<span class="token key attr-name">maximumPoolSize</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>
<span class="token comment"># 连接池空闲连接的最小数量</span>
<span class="token key attr-name">minimumIdle</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token comment"># 开启事务自动提交</span>
<span class="token key attr-name">autoCommit</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># 是否自定义配置，为true时下面两个参数才生效</span>
<span class="token key attr-name">dataSource.cachePrepStmts</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># 连接池大小默认25，官方推荐250-500</span>
<span class="token key attr-name">dataSource.prepStmtCacheSize</span><span class="token punctuation">=</span><span class="token value attr-value">250</span>
<span class="token comment"># 单条语句最大长度默认256，官方推荐2048</span>
<span class="token key attr-name">dataSource.prepStmtCacheSqlLimit</span><span class="token punctuation">=</span><span class="token value attr-value">2048</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="mybatis-批处理事务提交" tabindex="-1"><a class="header-anchor" href="#mybatis-批处理事务提交" aria-hidden="true">#</a> MyBatis 批处理事务提交</h3><p>为了方便在 MyBatis 中使用事务，我们需要重新获取一个 SqlSession；另外为了降低内存压力，批处理采用分批提交的方式，即把一个大集合切分成多个小集合来提交，最后一次性提交事务，把提交到数据库的 SQL 语句递交给 MySQL 服务端执行。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doImport</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span></span> maintains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 按每一批大小切割原集合</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> lists <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">splitList</span><span class="token punctuation">(</span>maintains<span class="token punctuation">,</span> <span class="token constant">BATCH_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 开启批量处理模式、关闭自动提交事务</span>
  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span><span class="token punctuation">.</span><span class="token constant">BATCH</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用这个创建出来的sqlSession获取Mapper，否则配置不生效</span>
    <span class="token class-name">MaintainMapper</span> maintainMapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">MaintainMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">:</span> lists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每次插入一批数据</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Maintain</span> maintain <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        maintainMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>maintain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 清除statementList</span>
      sqlSession<span class="token punctuation">.</span><span class="token function">flushStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 提交事务</span>
    sqlSession<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;MyBatis批处理事务插入方式花费时间 ==&gt; &quot;</span> <span class="token operator">+</span> stopWatch<span class="token punctuation">.</span><span class="token function">getLastTaskTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">splitList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> splitSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断集合是否为空</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 计算分割的份数</span>
  <span class="token comment">// (总数+每一份的数量-1) / 每一份的数量</span>
  <span class="token keyword">int</span> maxSize <span class="token operator">=</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> splitSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> splitSize<span class="token punctuation">;</span>
  <span class="token comment">//开始分割</span>
  <span class="token keyword">return</span>
    <span class="token comment">// 生成一个从0开始，长度为切割份数的序列</span>
    <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> integer <span class="token operator">-&gt;</span> integer <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 从数字转换成集合</span>
    <span class="token comment">// 每一份集合都跳过前(n*每一份数量)，然后取每一份数量</span>
    <span class="token comment">// 比如，第一份集合是跳过(0*1000=0)个元素，往后取1000个元素，就是第1个-第1000个元素组成了第一份集合</span>
    <span class="token comment">// 第二份集合是跳过(1*1000)个元素，往后取1000个元素，就是第1001个-第2000个元素组成了第二份集合</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>integer <span class="token operator">-&gt;</span> list<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> integer <span class="token operator">*</span> splitSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>splitSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>subList <span class="token operator">-&gt;</span> <span class="token operator">!</span>subList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insertBatchMaintain<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  insert into batch_maintain (maintain_num, maintain_name, equipment_num, maintain_type, functionary,
  maintain_duration, start_time, end_time, maintain_status)
  values
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>maintainList<span class="token punctuation">&#39;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>maintain<span class="token punctuation">&#39;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>,<span class="token punctuation">&#39;</span></span><span class="token punctuation">&gt;</span></span>
    (#{maintain.maintainNum}, #{maintain.maintainName}, #{maintain.equipmentNum}, #{maintain.maintainType},
    #{maintain.functionary}, #{maintain.maintainDuration}, #{maintain.startTime}, #{maintain.endTime},
    #{maintain.maintainStatus})
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>数据量/插入时间(毫秒)</th><th>第一次</th><th>第二次</th><th>第三次</th></tr></thead><tbody><tr><td>5w条</td><td>7698</td><td>7629</td><td>7493</td></tr><tr><td>10w条</td><td>15694</td><td>15887</td><td>15339</td></tr><tr><td>20w条</td><td>24564</td><td>22924</td><td>26506</td></tr><tr><td>40w条</td><td>55419</td><td>57856</td><td>57416</td></tr></tbody></table><h3 id="mybatis-plus-批处理事务提交" tabindex="-1"><a class="header-anchor" href="#mybatis-plus-批处理事务提交" aria-hidden="true">#</a> MyBatis-Plus 批处理事务提交</h3><p>这里没有显式地控制事务，为什么也是事务提交呢？对底层源码查看到 <code>saveBatch()</code> 方法是利用分片处理（默认 batchSize 是 1000） + <strong>分批提交事务</strong>（当处理的数据达到 batchSize 时会触发 <code>flushStatements()</code> 方法）的操作，从而提高性能。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doImport</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span></span> maintains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用MyBatis-Plus封装的批处理方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maintainService<span class="token punctuation">.</span><span class="token function">saveBatch</span><span class="token punctuation">(</span>maintains<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;MyBatis-Plus批处理插入方式花费时间 ==&gt; &quot;</span> <span class="token operator">+</span> stopWatch<span class="token punctuation">.</span><span class="token function">getLastTaskTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>数据量/插入时间(毫秒)</th><th>第一次</th><th>第二次</th><th>第三次</th></tr></thead><tbody><tr><td>5w条</td><td>6703</td><td>6408</td><td>6445</td></tr><tr><td>10w条</td><td>11355</td><td>11657</td><td>11493</td></tr><tr><td>20w条</td><td>22735</td><td>22482</td><td>24238</td></tr><tr><td>40w条</td><td>51405</td><td>51292</td><td>50074</td></tr></tbody></table><h3 id="jdbc-批处理直接提交" tabindex="-1"><a class="header-anchor" href="#jdbc-批处理直接提交" aria-hidden="true">#</a> JDBC 批处理直接提交</h3><p>JDBC 批量提交的方式是</p><ol><li>使用 <code>addBatch()</code> 方法把语句放到缓存区</li><li>调用 <code>executeBatch()</code> 方法一次性把这些语句都提交到数据库</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doImport</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span></span> maintains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    connection <span class="token operator">=</span> <span class="token class-name">HikariCPUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into batch_maintain (maintain_num, maintain_name, equipment_num, maintain_type, functionary, maintain_duration, start_time, end_time, maintain_status) values (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="token punctuation">;</span>
    preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Maintain</span> maintain <span class="token operator">:</span> maintains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getEquipmentNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getFunctionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token class-name">Timestamp</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>maintain<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token class-name">Timestamp</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>maintain<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 提交到缓存区</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">%</span> <span class="token constant">BATCH_SIZE</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一次性提交缓存区中的SQL语句</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HikariCPUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>preparedStatement<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc批处理插入方式花费时间 ==&gt; &quot;</span> <span class="token operator">+</span> stopWatch<span class="token punctuation">.</span><span class="token function">getLastTaskTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>数据量/插入时间(毫秒)</th><th>第一次</th><th>第二次</th><th>第三次</th></tr></thead><tbody><tr><td>5w条</td><td>3397</td><td>3350</td><td>3240</td></tr><tr><td>10w条</td><td>9199</td><td>8993</td><td>9052</td></tr><tr><td>20w条</td><td>17421</td><td>17817</td><td>17676</td></tr><tr><td>40w条</td><td>31198</td><td>32074</td><td>32561</td></tr></tbody></table><h3 id="jdbc-批处理事务提交" tabindex="-1"><a class="header-anchor" href="#jdbc-批处理事务提交" aria-hidden="true">#</a> JDBC 批处理事务提交</h3><p>JDBC 事务提交使用方式也很简单</p><ol><li><code>connection.setAutoCommit(false)</code> 设置手动提交</li><li><code>connection.commit()</code> 执行批处理后提交事务</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doImport</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Maintain</span><span class="token punctuation">&gt;</span></span> maintains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    connection <span class="token operator">=</span> <span class="token class-name">HikariCPUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开启事务手动提交</span>
    connection<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into batch_maintain (maintain_num, maintain_name, equipment_num, maintain_type, functionary, maintain_duration, start_time, end_time, maintain_status) values (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="token punctuation">;</span>
    preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Maintain</span> maintain <span class="token operator">:</span> maintains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getEquipmentNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getFunctionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token class-name">Timestamp</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>maintain<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token class-name">Timestamp</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>maintain<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> maintain<span class="token punctuation">.</span><span class="token function">getMaintainStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">%</span> <span class="token constant">BATCH_SIZE</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一次性提交缓存区中的SQL语句</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      preparedStatement<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 提交事务</span>
    connection<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HikariCPUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>preparedStatement<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc批处理事务插入方式花费时间 ==&gt; &quot;</span> <span class="token operator">+</span> stopWatch<span class="token punctuation">.</span><span class="token function">getLastTaskTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>数据量/插入时间(毫秒)</th><th>第一次</th><th>第二次</th><th>第三次</th></tr></thead><tbody><tr><td>5w条</td><td>3240</td><td>3428</td><td>3153</td></tr><tr><td>10w条</td><td>6606</td><td>6281</td><td>7160</td></tr><tr><td>20w条</td><td>12014</td><td>14157</td><td>14655</td></tr><tr><td>40w条</td><td>23317</td><td>25490</td><td>22860</td></tr></tbody></table><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><ul><li><p>使用 MyBatis 的方式使用批量提交 insert 语句而不是批量拼接 insert 语句的 value，主要的考量是数据库服务端解析长的 SQL 语句会更加耗时。诚然使用 insert 语句拼接 value 的话，提交到服务器上的 insert 语句少了，网络负载少了，性能也能提上去，<strong>但是这是建立在数据量不大的情况下</strong>，当数据量变大，这条 insert 语句会变得很长，<code>innodb_buffer_pool_size</code> 有限制，过长的 SQL 在写操作的时候由于<strong>超过内存阈值</strong>，发生了磁盘交换。所以单纯 value 拼接方案难以经受大量数据的考验，只能在特定数量之内安全的提升性能，这么看 MyBatis-Plus 默认方案的选择也有一定的道理。</p></li><li><p>从结果看 JDBC 原生要比 MyBatis-Plus 更快，原因可能是 MyBatis-Plus 的方法在处理数据插入操作时，需要进行 ORM 转换，效率一般；原生的 JDBC 直接使用 SQL 语句，无需转换，效率更高。</p></li><li><p>在批处理中，尽管使用事务和不使用事务总体上时间差距不大（可能需要增大测试的数据量），但还是要比不使用事务快一点点；而实际上在循环单条插入时速度差异更大，原因是在循环单条插入时 MySQL 把每一个插入操作都看成是一个事务，这意味着每一个插入操作都需要把日志数据写入磁盘，而使用事务提交时，这些所有的插入操作都只进行一次日志数据的写入，IO 次数更少，效率也就更高。</p></li><li><p>其中使用批处理时非常值得考虑一个问题就是分批提交，虽然这会比直接批处理要慢一点，但是由于数据库每次接收的 SQL 语句的数量是有上限的，如果批处理提交的数量超出这个上限，那么很可能导致数据库拒绝这一批数据并抛出异常，查看 MySQL 一次发送的数据包的大小上限的语句： <code>SHOW VARIABLES LIKE &#39;%max_allowed_packet%&#39;;</code> 。另外把大量的数据分成多批进行批处理也能有效降低 JDBC 客户端的内存压力。</p></li><li><p>在处理大批量数据时，<strong>建议使用原生 JDBC 批量 + 分批 + 事务提交</strong>，既能保证效率，又能尽可能避免出现内存泄漏等问题。</p></li></ul><h2 id="参考链接" tabindex="-1"><a class="header-anchor" href="#参考链接" aria-hidden="true">#</a> 参考链接</h2>`,43),k={href:"https://dandelioncloud.cn/article/details/1482640589962424322",target:"_blank",rel:"noopener noreferrer"},r={href:"https://blog.csdn.net/LJFPHP/article/details/99708888",target:"_blank",rel:"noopener noreferrer"},d={href:"https://cdn.modb.pro/db/175259",target:"_blank",rel:"noopener noreferrer"},m={href:"https://www.cnblogs.com/chenjianjx/archive/2012/08/14/2637914.html",target:"_blank",rel:"noopener noreferrer"};function v(b,h){const s=e("ExternalLinkIcon");return c(),o("div",null,[u,n("p",null,[n("a",k,[a("号称全网最快的数据库连接池HikariCP的工具类开发-HikariCPUtils"),t(s)])]),n("p",null,[n("a",r,[a("mysql批量插入数据，一次插入多少行数据效率最高？"),t(s)])]),n("p",null,[n("a",d,[a("MyBatis-Plus 批处理有坑，我教你改造"),t(s)])]),n("p",null,[n("a",m,[a("介绍MySQL Jdbc驱动的rewriteBatchedStatements参数"),t(s)])])])}const S=p(l,[["render",v],["__file","MySQL-batch-insert.html.vue"]]);export{S as default};
