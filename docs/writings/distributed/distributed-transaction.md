# 分布式事务

> 本节我们简单了解分布式事务的概念及其常见的解决方案

## 概念

在了解分布式事务前，我们先回顾两个概念

- 分布式架构：传统系统的架构一般是所有资源（前后端代码、数据库等）都统一放到同一个计算机上面，而分布式架构就是区别于这种架构的，即程序和数据通过网络分布在多于一个的计算机上的架构。

- 事务：一个包含多个步骤的业务操作，这些步骤要么全部成功，要么全部失败。

那分布式事务的概念其实很容易理解：一个分布在多于一个计算机（节点）上且包含多个步骤的业务操作，这些步骤要么全部成功，要么全部失败。分布式事务是用于分布式系统中保证不同节点之间的数据一致性。

举个简单的例子：在一个电商系统中，顾客下单后需要扣减库存并且用户得到积分，如果订单服务、库存服务、积分服务都是互相独立的服务，那么在生成订单的时候需要保证订单系统的事务正确提交，也需要同时保证库存服务和积分服务的事务正确提交。


## 分布式事务解决方案

### XA 协议

在了解各个分布式事务解决方案前，先简单了解一下分布式事务中一个非常著名的协议：XA 协议，后面提到的各种解决方案都是基于这个协议开展的。

XA 协议中划分了两个角色：

- 事务管理者：一个全局调度的角色，决定了本次事务成功或失败。
- 资源管理者：负责执行事务的角色。


### 2PC (两阶段提交)

两阶段提交是 XA 协议的一个实现

总体上的流程分成了两个阶段：

- 准备阶段：事务管理者向所有资源管理者发送事务内容，资源管理者执行事务但不提交，并询问各资源管理者是否可以提交事务。
- 提交阶段：事务管理者根据准备阶段中得到的反馈消息，决定本次事务是 `Commit` 状态还是 `Rollback` 状态，并向所有每个资源管理者发送具体事务状态的指令，所有资源管理者根据事务管理者的指令执行提交或者回滚操作，释放所有事务处理过程中使用的锁资源。