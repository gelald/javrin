## 微服务网关作用介绍

**解决的问题**

认证、鉴权、安全、流量管控、缓存、服务路由、协议转换、服务编排、熔断、灰度发布、监控报警等

**特点**

公共服务、业务无关、第一流量入口

| 功能点         | 功能说明                                                     |
| -------------- | ------------------------------------------------------------ |
| 认证           | 支持4种认证方式，包括：Basic认证、JWT认证、微信小程序Token认证、NULL认证（放行） |
| 鉴权           | 支持2中授权方式，包括：基于接入应用进行授权、NULL授权（放行） |
| 流量管控       | 支持2种流程管理，包括：基于客户端应用进行流量管控，防止客户端恶意获取数据；基于API的流量管理，保护上流服务，支持多种时间纬度进行限流；支持本地和分布式限流 |
| 缓存           | 缓存API后端服务返回的数据，降低后端服务的压力                |
| 安全防护       | 客户端身份认证；只有授权的应用才能访问对应的API；公私钥算法保护API接口调用和数据传输安全；IP白名单、黑名单机制；防重放；通过组件二次开发可以扩展很多定制安全功能 |
| **服务路由**   | 识别请求参数和路径转发上游API服务（流量分发）；服务地址伪装，可将内部服务伪装成一个不易识别的地址暴露到公网 |
| 日志记录       | 对API调用情况进行汇总记录，也支持配置第三方服务记录完整的API调用详细信息，方便自定义审计和统计 |
| 服务注册和暴露 | 支持HTTP Rest、WebService服务注册和暴露                      |
| 协议转换       | 支持将WebService服务转换成Restful对外提供服务；引入脚本引擎，支持各类参数自定义转换；扩展协议转换组件，实现更多类型的服务接入平台 |
| 负载均衡       | 支持网关内部负载均衡，用户可以选择注册代理和服务实例地址，网关通过心跳检测机制自动探测服务实例的可用性 |
| 服务编排       | 提供WebIDE实现图形化的方式编辑服务流程；将各类异构服务以SOA的形式进行编排，替代原有ESB系统，更加高效 |
| DB快速开发     | 对接各种数据源，无需应用快速生成新的API                      |

## 网关种类划分

### 微服务网关

快速构建基于微服务架构的应用系统，微服务网关是微服务架构的标准组件

### API网关

- **微服务整合**

  API网关可以封装微服务Rest API。通过这种方式，经API网关调用API，并由API网关统一身份验证和监视。此外，API网关还可以控制外部公开的API来降低安全风险

- **多端统一**

  API网关允许使用一组后端服务来服务各种终端；通过协议的自适应和转换，可以满足不同终端对不同协议的要求；**此外，还可以分别授权不同的终端，可以避免调整或配置后端服务**

- **业务整合**

  API网关可以统一业务的子模块API。其聚合服务帮助开发者专注于业务的迭代，而不是潜在的资源与能力，提高了整体的工作效率

### 准入网关

- **访问准入控制**

  访问时需要经过准入网关严格的审核，只有合法的计算机才能连入访问，非法计算机可根据需要将其引导至**隔离区**进行修复，或者完全阻断其访问

- **安全合规检查**

  安全状态合规检查，满足条件则允许接入网络，否则拒绝访问并发出警告提示，并强制其跳转至隔离区进行相关修复

- **账号登录**

  临时来访的外来计算机，因工作需要接入企业内部网络时，可以设定访客账号，通过浏览器输入账号密码进行身份认证，通过后方可连接网络

- **脱离管控**

  准入网关可以有效防止内部计算机通过重装系统、安装多系统、虚拟机等方式脱离管控，保证内网安全策略可以有效的执行

### 接入网关

- **多链路**

  支持宽带WAN、4G和专线多个链路上云

- **路由方式**

  静态路由、BGP动态路由和OSPF动态路由

- **服务质量QoS**

  划分不同业务的流量带宽，保证高优先级的流量带宽

- **网络地址转换NAT**

  隐藏内部网络地址，解决私网地址冲突，提高网络安全性

- **访问控制**

  针对不同的智能接入网络实例设置访问白名单或黑名单

- **流日志**

  记录智能接入网关的传入和传出流量信息

- **健康检查**

  健康检查接入网关设备可发送探测报文检测目的连通性

## 微服务网关画像与架构

### Zuul 网关画像

#### 架构 

![](https://gitee.com/ngyb/pic/raw/master/zuul%E6%9E%B6%E6%9E%84.png)

- Zuul Servlet负责接入请求

- Groovy Filter 过滤器



- 责任链模式（过滤器/拦截器）

- Pre routing filters 前置路由：鉴权、限流、黑名单

- Routing filters 路由：服务路由等

- Post routing filters 后置路由：加密响应等



- RequestContext 请求上下文 把数据携带到业务服务中



#### 过滤器生命周期

![](https://gitee.com/ngyb/pic/raw/master/%E8%BF%87%E6%BB%A4%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png)

- 可以自定义前置过滤器，设置各种过滤条件

- 可以自定义后置过滤器，处理响应

### Gateway 网关画像

#### 架构

![](https://gitee.com/ngyb/pic/raw/master/Gateway%E6%9E%B6%E6%9E%84.png)

- Proxy Filter 代理过滤器就是路由过滤器 负责路由到对应的服务

- 和Zuul相比的优势，过滤条件更加灵活，过滤器分为全局过滤器和非全局过滤器，**能为每一个请求设定断言、过滤器**