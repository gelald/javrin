# Java 字节码详解



## JVM 概述

由于计算机只认识 0 和 1，这意味着任何语言编写的程序最终都需要经过编译器编译成机器码才能被计算机执行。所以在不同平台上运行编写的程序前，都需要重新编译才可以。而 Java 刚推出的时候，口号是：Write Once，Run Anywhere

为了实现”编写一次，到处运行“的目的，Sun 公司发布了许多可以运行在不同平台上的 JVM，而这些虚拟机都拥有一个共同的功能，那就是可以载入和执行同一种与平台无关的字节码(ByteCode)。于是，Java 源代码不再需要直接根据平台来翻译成 0/1 这种机器码，而是先翻译成字节码，然后通过不同平台上的 JVM 读取并运行，从而实现上述目的。

如今 JVM 更是扩大了应用的范围，不仅支持 Java 代码，还支持许多基于 JVM 的编程语言，如 Koltin、Groovy 等

![](https://gitee.com/ngwingbun/picgo-image/raw/master/images/20220316154251.png)



## Java 字节码文件

class 文件本质上是一个 8 位字节为基础单位的二进制流，各个数据项目紧凑地排列在 class 文件中。JVM 就根据特定的规则来解析这个二进制的数据，从而得到类的信息

先准备一个 Java 文件

```java
public class Test {
    private int m;

    public int inc() {
        return m + 1;
    }
}
```

打开编译后的 class 文件

```
cafe babe 0000 0034 0013 0a00 0400 0f09
0003 0010 0700 1107 0012 0100 016d 0100
0149 0100 063c 696e 6974 3e01 0003 2829
5601 0004 436f 6465 0100 0f4c 696e 654e
756d 6265 7254 6162 6c65 0100 0369 6e63
0100 0328 2949 0100 0a53 6f75 7263 6546
696c 6501 0009 5465 7374 2e6a 6176 610c
0007 0008 0c00 0500 0601 0004 5465 7374
0100 106a 6176 612f 6c61 6e67 2f4f 626a
6563 7400 2100 0300 0400 0000 0100 0200
0500 0600 0000 0200 0100 0700 0800 0100
0900 0000 1d00 0100 0100 0000 052a b700
01b1 0000 0001 000a 0000 0006 0001 0000
0001 0001 000b 000c 0001 0009 0000 001f
0002 0001 0000 0007 2ab4 0002 0460 ac00
0000 0100 0a00 0000 0600 0100 0000 0500
0100 0d00 0000 0200 0e
```



### class 文件的结构属性

#### 魔数

每个 class 文件的头4个字节成为魔数（Magic Number），它的唯一作用是确定这个文件是否为一个能被虚拟机接受的 class 文件，为 0xCAFEBABE

> 可以上面 class 文件前4个字节就是 ("cafe babe")

#### 版本号

紧接着魔数的这个字节存储的是 class 文件的版本号，第5和第6个字节是次版本号；第7和第8个字节是主版本号

> 上面 class 文件第5、6个字节是0000，代表jdk次版本为0；第7、8个字节是0034，代表jdk主版本为52，但是jdk版本从45开始，除1.0和1.1都使用45.x外，每升级一个大版本，版本号都加1，所以生成该 class 文件的jdk的版本号为1.8.0

#### 常量池

常量池可以理解为 class 文件的资源仓库，是占用 class 文件空间最大的数据项目之一。常量池存储的资源有：变量的属性、类型和名称；方法的属性、类型和名称。

常量池主要存放两大类常量：字面量和符号引用

- 字面量比较接近 Java 中的常量的概念，如文本字符串、被声明为 final 的常量值
- 符号引用，包括三类常量：类的接口的全限定类名、方法的名称和描述符、属性的名称和描述符

#### 访问标识

用于标识这个 Class 的属性和访问类型，包括：这个 Class 是类还是接口；访问类型是否为 public；是否定义为 abstract 类型；如果是类的话，是否被声明为 final 等

#### 类索引、父类索引、接口索引

类索引、父类索引、接口索引可以理解为一种描述的数据项目。class 文件依靠类索引、父类索引、接口索引来确定这个类的继承关

#### 字段表属性

用于描述接口或类中声明的变量。类的作用域（public、private、protected）、是否为静态变量（static）、是否可变（final）、数据类型（基本数据类型、引用类型）等

#### 方法表属性

与字段表属性类似，只不过方法表属性描述的是方法的类型、作用域等

#### 属性表属性

用于记录字段表、方法表的特殊属性



### 反编译字节码文件

> jdk 内置的反编译工具 javap 可以完成反编译字节码文件的工作

用法：`javap <options> <classfile>`

其中 `<options>` 常用的选项包括

```
-v  -verbose             输出附加信息
-l                       输出行号和本地变量表
-public                  仅显示公共类和成员
-protected               显示受保护的/公共类和成员
-package                 显示程序包/受保护的/公共类和成员 (默认)
-p  -private             显示所有类和成员
```

使用 `javap -verbose -p Test.class` 查看输出内容

```
Classfile /xxx/Test.class
  Last modified 2022-3-16; size 265 bytes
  MD5 checksum 7cab5513115a4982f1d0f04048c0f405
  Compiled from "Test.java"
public class Test
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #4.#15         // java/lang/Object."<init>":()V
   #2 = Fieldref           #3.#16         // Test.m:I
   #3 = Class              #17            // Test
   #4 = Class              #18            // java/lang/Object
   #5 = Utf8               m
   #6 = Utf8               I
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               inc
  #12 = Utf8               ()I
  #13 = Utf8               SourceFile
  #14 = Utf8               Test.java
  #15 = NameAndType        #7:#8          // "<init>":()V
  #16 = NameAndType        #5:#6          // m:I
  #17 = Utf8               Test
  #18 = Utf8               java/lang/Object
{
  private int m;
    descriptor: I
    flags: ACC_PRIVATE

  public Test();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 1: 0

  public int inc();
    descriptor: ()I
    flags: ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: getfield      #2                  // Field m:I
         4: iconst_1
         5: iadd
         6: ireturn
      LineNumberTable:
        line 5: 0
}
SourceFile: "Test.java"
```

